#! /bin/bash

# Example panel for LemonBoy's bar

source ~/.config/panel/panelrc

num_mon=$(bspc query -M | wc -l)

# Defaults
while read -r line ; do
	case $line in
		CMUS*)
			# cmus output
			# now_playing="%{F$COLOR_LAYOUT_FG}%{B$COLOR_LAYOUT_BG} \u266B $(display "${line:4}") %{B-}%{F-}"
			c_status=$(echo ${line:4} | cut -d ':' -f1)
			c_artist=$(echo ${line:4} | cut -d ':' -f2)
			c_album=$(echo ${line:4} | cut -d ':' -f3)
			c_title=$(echo ${line:4} | cut -d ':' -f4)
			c_year=$(echo ${line:4} | cut -d ':' -f5)

			if [[ "$c_status" == 'not_running' ]] || [ -z "$c_status" ]; then
				now_playing="%{F$COLOR_NOTIFICATION_FG} CMUS is not running. %{F-}"
			else
				if [ "$c_status" == "paused" ]; then
					now_playing="%{F$COLOR_NOTIFICATION_FG} $ICON_MUSIC_PAUSED Paused %{F-}"
				else
					now_playing="%{F$COLOR_NOTIFICATION_FG} $ICON_MUSIC_PLAYING $(display "$c_artist - $c_title") %{F-}"
				fi
			fi
			;;
		VOL*)
			# volume output
			vol_status=$(echo ${line:3} | cut -d ':' -f1)
			vol_level=$(echo ${line:3} | cut -d ':' -f2)

			if [ "$vol_status" == 'off' ]; then
				volume="%{B$COLOR_BACKGROUND}%{F$COLOR_URGENT_FG} $ICON_VOL_MUTED Muted %{F-}%{B-}"
			else
				vol_icon=$ICON_VOL_NORMAL
				if [[ $vol_level -le 0 ]]; then
					vol_icon=$ICON_VOL_MUTED
				elif [[ $vol_level -ge 50 ]]; then
					vol_icon=$ICON_VOL_HIGH
				fi
				volume="%{B$COLOR_BACKGROUND}%{F$COLOR_WARNING_FG} $vol_icon $vol_level% %{F-}%{B-}"
			fi
			;;
    BAT*)
      # battery output
      bat_level=$(echo ${line:3} | cut -d ':' -f1)
      bat_icon=$ICON_BAT_HIGH
      battery="%{B$COLOR_BACKGROUND}%{F$COLOR_FOREGROUND} $bat_icon $bat_level% %{F-}%{B-}"
      ;;
		S*)
			# clock output
			sys_infos="%{F$COLOR_STATUS_FG}%{B$COLOR_STATUS_BG} $ICON_CLOCK ${line:1} %{B-}%{F-}"
			;;
		T*)
			# xtitle output
			title="%{F$COLOR_TITLE_FG}%{B$COLOR_TITLE_BG} %{B$COLOR_TITLE_ICON_BG}%{F$COLOR_TITLE_ICON_FG}$ICON_TITLE%{F-}%{B-} $(display "${line:1}") %{B-}%{F-}"
			;;
		W*)
			# bspwm internal state
			wm_infos=""
			IFS=':'
			set -- ${line:1}
			while [ $# -gt 0 ] ; do
				item=$1
				name=${item:1}
				case $item in
					M*)
						# active monitor
						if [ $num_mon -gt 1 ] ; then
							wm_infos="$wm_infos %{F$COLOR_ACTIVE_MONITOR_FG}%{B$COLOR_ACTIVE_MONITOR_BG} ${name} %{B-}%{F-}  "
						fi
						;;
					m*)
						# inactive monitor
						if [ $num_mon -gt 1 ] ; then
							wm_infos="$wm_infos %{F$COLOR_INACTIVE_MONITOR_FG}%{B$COLOR_INACTIVE_MONITOR_BG} ${name} %{B-}%{F-}  "
						fi
						;;
					O*)
						# focused occupied desktop
						wm_infos="${wm_infos}%{F$COLOR_FOCUSED_OCCUPIED_FG}%{B$COLOR_FOCUSED_OCCUPIED_BG}%{U$COLOR_FOREGROUND} ${name} %{B-}%{F-}"
						;;
					F*)
						# focused free desktop
						wm_infos="${wm_infos}%{F$COLOR_FOCUSED_FREE_FG}%{B$COLOR_FOCUSED_FREE_BG}%{U$COLOR_FOREGROUND} ${name} %{B-}%{F-}"
						;;
					U*)
						# focused urgent desktop
						wm_infos="${wm_infos}%{F$COLOR_FOCUSED_URGENT_FG}%{B$COLOR_FOCUSED_URGENT_BG}%{U$COLOR_FOREGROUND} ${name} %{B-}%{F-}"
						;;
					o*)
						# occupied desktop
						wm_infos="${wm_infos}%{F$COLOR_OCCUPIED_FG}%{B$COLOR_OCCUPIED_BG} ${name} %{B-}%{F-}"
						;;
					f*)
						# free desktop
						wm_infos="${wm_infos}%{F$COLOR_FREE_FG}%{B$COLOR_FREE_BG} ${name} %{B-}%{F-}"
						;;
					u*)
						# urgent desktop
						wm_infos="${wm_infos}%{F$COLOR_URGENT_FG}%{B$COLOR_URGENT_BG} ${name} %{B-}%{F-}"
						;;
					L*)
						# layout
						layout_icon='\uE009'
						if [[ $name == M* ]]; then
							layout_icon='\uE001'
						fi
						wm_infos="$wm_infos  %{F$COLOR_LAYOUT_FG}%{B$COLOR_LAYOUT_BG} $layout_icon %{B-}%{F-}"
						;;
				esac
				shift
			done
			IFS=
			;;
	esac

	printf \
		'%%{l}%b%%{c}%b%%{r}%b%b%b%b\n' \
		"${wm_infos}" "${title}" "${now_playing}" "${volume}" "${battery}" "${sys_infos}";

done
